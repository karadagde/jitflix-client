"use strict";(self.webpackChunkserverApp=self.webpackChunkserverApp||[]).push([[281],{7281:(N,p,s)=>{s.r(p),s.d(p,{VideoCallModule:()=>w});var a=s(6895),r=s(4006),f=s(4859),h=s(3546),v=s(3238),d=s(9549),u=s(4144),g=s(4385),C=s(7518),m=s(5861),S=s(7579),y=s(5684),T=s(2722),O=s(1135),V=s(5026),e=s(4650);let l=(()=>{class o{constructor(){this.configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},this.peerConnection=new RTCPeerConnection(this.configuration),this.messageSubject$=new O.X([]),this.socketAddress="ws://localhost:8080/socket",this.message$=this.messageSubject$.asObservable().pipe((0,V.R)((t,n)=>t.concat(n)))}connectToWebSocketServer(){var t=this;return(0,m.Z)(function*(){t.webSocket=new WebSocket(t.socketAddress),t.webSocket.onmessage=n=>{console.dir("Received message: "+n),console.log(n),t.handleWebSocketMessage(n)},t.peerConnection.onicecandidate=n=>{n.candidate&&t.webSocket.send(JSON.stringify({candidate:n.candidate}))}})()}handleWebSocketMessage(t){const n=JSON.parse(t.data);n.sdp?(this.peerConnection.setRemoteDescription(new RTCSessionDescription(n.sdp)),"offer"===n.sdp.type&&this.peerConnection.createAnswer().then(c=>this.setAndSendDescription(c))):n.candidate?this.peerConnection.addIceCandidate(new RTCIceCandidate(n.candidate)):n.message&&this.messageSubject$.next([n.message])}setAndSendDescription(t){this.peerConnection.setLocalDescription(t),this.webSocket.send(JSON.stringify({sdp:t}))}getLocalStream(){this.webSocket.onopen=t=>{console.log(t),console.log("Connection state: "+this.webSocket.readyState),console.log("Connection state: "+this.webSocket.OPEN),console.log("Connected"),this.peerConnection.createOffer().then(n=>this.setAndSendDescription(n))}}handleIncomingTracks(t){this.peerConnection.ontrack=n=>{t.srcObject!==n.streams[0]&&(t.srcObject=n.streams[0])}}createAnswer(){1===this.webSocket.readyState&&(console.log("createAnswer"),this.peerConnection.createOffer().then(t=>this.setAndSendDescription(t)))}sendMessage(t){this.webSocket.send(JSON.stringify({message:t}))}disconnect(){this.webSocket.close(),this.peerConnection.close()}}return o.\u0275fac=function(t){return new(t||o)},o.\u0275prov=e.Yz7({token:o,factory:o.\u0275fac}),o})();const Z=["liveVideo"];function A(o,i){if(1&o&&(e.TgZ(0,"mat-option",9),e._uU(1),e.qZA()),2&o){const t=i.$implicit;e.Q6J("value",t.deviceId),e.xp6(1),e.hij(" ",t.label," ")}}function b(o,i){if(1&o&&(e.TgZ(0,"mat-option",9),e._uU(1),e.qZA()),2&o){const t=i.$implicit;e.Q6J("value",t.deviceId),e.xp6(1),e.hij(" ",t.label," ")}}let x=(()=>{class o{constructor(t){this.service=t,this.destroy$=new S.x,this.videoDevices=[],this.audioDevices=[],this.form=new r.cw({videoOptions:new r.NI("",r.kI.required),audioOptions:new r.NI("",r.kI.required)}),this.freeText=new r.NI("")}selectCamera(){return this.form.get("videoOptions")?.value}selectMicrophone(){return this.form.get("audioOptions")?.value}getText(){return this.freeText.value}setInputDevices(t){var n=this;return(0,m.Z)(function*(){const c=yield navigator.mediaDevices.getUserMedia(t);n.liveVideo.nativeElement.srcObject=c})()}getAndDisplayLocalStream(){var t=this;return(0,m.Z)(function*(){t.service.getLocalStream()})()}ngOnInit(){this.service.connectToWebSocketServer(),this.getAndDisplayLocalStream(),this.form.valueChanges.pipe((0,y.T)(1),(0,T.R)(this.destroy$)).subscribe(()=>{if(this.form.valid){const t={video:{deviceId:this.selectCamera()},audio:{deviceId:this.selectMicrophone()}};this.setInputDevices(t)}})}ngOnDestroy(){this.destroy$.next(!0),this.destroy$.unsubscribe(),this.service.disconnect()}sendMessage(){const t=this.getText();console.log(t),t&&(this.service.sendMessage(t),this.freeText.patchValue(""),this.freeText.markAsPristine())}}return o.\u0275fac=function(t){return new(t||o)(e.Y36(l))},o.\u0275cmp=e.Xpm({type:o,selectors:[["app-live-streaming"]],viewQuery:function(t,n){if(1&t&&e.Gf(Z,7),2&t){let c;e.iGM(c=e.CRH())&&(n.liveVideo=c.first)}},features:[e._Bn([l])],decls:21,vars:4,consts:[[1,"liveStream-container"],["autoplay","","controls",""],["liveVideo",""],[3,"formGroup"],["formControlName","videoOptions"],[3,"value",4,"ngFor","ngForOf"],["formControlName","audioOptions"],["matInput","",3,"formControl"],["mat-flat-button","","color","primary","type","button",3,"click"],[3,"value"]],template:function(t,n){1&t&&(e.TgZ(0,"div",0),e._UZ(1,"video",1,2),e.TgZ(3,"form",3)(4,"mat-form-field")(5,"mat-label"),e._uU(6,"Video"),e.qZA(),e.TgZ(7,"mat-select",4),e.YNc(8,A,2,2,"mat-option",5),e.qZA()(),e.TgZ(9,"mat-form-field")(10,"mat-label"),e._uU(11,"Audio"),e.qZA(),e.TgZ(12,"mat-select",6),e.YNc(13,b,2,2,"mat-option",5),e.qZA()()(),e.TgZ(14,"mat-form-field")(15,"mat-label"),e._uU(16,"Socket-message"),e.qZA(),e.TgZ(17,"textarea",7),e._uU(18," "),e.qZA()(),e.TgZ(19,"button",8),e.NdJ("click",function(){return n.sendMessage()}),e._uU(20," Send Message "),e.qZA()()),2&t&&(e.xp6(3),e.Q6J("formGroup",n.form),e.xp6(5),e.Q6J("ngForOf",n.videoDevices),e.xp6(5),e.Q6J("ngForOf",n.audioDevices),e.xp6(4),e.Q6J("formControl",n.freeText))},dependencies:[a.sg,r._Y,r.Fj,r.JJ,r.JL,r.oH,r.sg,r.u,d.KE,d.hX,v.ey,g.gD,u.Nt,f.lW],styles:[".liveStream-container[_ngcontent-%COMP%]{margin:auto;margin-top:8rem;display:flex;gap:1rem;flex-wrap:wrap}.liveStream-container[_ngcontent-%COMP%] > video[_ngcontent-%COMP%]{margin-left:2rem;max-height:720px;aspect-ratio:4/3}.liveStream-container[_ngcontent-%COMP%] > form[_ngcontent-%COMP%]{margin-left:2rem;display:flex;flex-direction:column;gap:1rem}"]}),o})();const M=["liveVideoReceiver"];function D(o,i){if(1&o&&(e.TgZ(0,"li"),e._uU(1),e.qZA()),2&o){const t=i.$implicit;e.xp6(1),e.hij(" ",t," ")}}function I(o,i){if(1&o&&(e.TgZ(0,"ul"),e.YNc(1,D,2,1,"li",4),e.qZA()),2&o){const t=i.ngIf;e.xp6(1),e.Q6J("ngForOf",t)}}let k=(()=>{class o{constructor(t){this.service=t}ngOnInit(){this.service.connectToWebSocketServer(),this.service.handleIncomingTracks(this.liveVideoReceiver.nativeElement)}ngOnDestroy(){this.service.disconnect()}}return o.\u0275fac=function(t){return new(t||o)(e.Y36(l))},o.\u0275cmp=e.Xpm({type:o,selectors:[["app-receive-stream"]],viewQuery:function(t,n){if(1&t&&e.Gf(M,7),2&t){let c;e.iGM(c=e.CRH())&&(n.liveVideoReceiver=c.first)}},features:[e._Bn([l])],decls:6,vars:3,consts:[[2,"margin-top","100px"],[4,"ngIf"],["autoplay","","controls",""],["liveVideoReceiver",""],[4,"ngFor","ngForOf"]],template:function(t,n){1&t&&(e.TgZ(0,"p",0),e._uU(1,"receive-stream works!"),e.qZA(),e.YNc(2,I,2,1,"ul",1),e.ALo(3,"async"),e._UZ(4,"video",2,3)),2&t&&(e.xp6(2),e.Q6J("ngIf",e.lcZ(3,1,n.service.message$)))},dependencies:[a.sg,a.O5,a.Ov],styles:["video[_ngcontent-%COMP%]{margin-left:2rem;max-height:720px;aspect-ratio:4/3}"]}),o})(),w=(()=>{class o{}return o.\u0275fac=function(t){return new(t||o)},o.\u0275mod=e.oAB({type:o}),o.\u0275inj=e.cJS({imports:[a.ez,r.UX,h.QW,d.lN,v.Ng,g.LD,u.c,f.ot,C.Bz.forChild([{path:"call",component:x},{path:"answer",component:k}])]}),o})()}}]);